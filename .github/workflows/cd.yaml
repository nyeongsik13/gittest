name: Deploy

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '16'
          cache: 'yarn'

      - name: Install Dependencies with Yarn
        run: yarn install

      # Removed the "Build your project with Yarn" step here
 
      - name: Copy files to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_KEY }}
          port: 22
          source: "./" # Copying everything from the root. Change this if needed.
          target: "~/your-target-directory"
          strip_components: 1

      - name: SSH Commands 
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script_stop: true
          script: |
             # Stop the existing Node.js process
             pm2 stop all || true
             # Move to the project directory, make sure you update this to the correct path
             cd ~/your-target-directory
             # Install dependencies
             yarn install --production
             # Start the application using pm2, replace with your actual start command
             pm2 start app.js --name your-app-name # Update `app.js` with your actual file
             # Check the pm2 process list
             pm2 list
